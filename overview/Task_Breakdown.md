# 项目任务拆解：解谜系统 Web 编辑器

---

## 阶段一：项目奠基与架构设计

> 目标：搭好整体骨架，统一数据结构和交互规范，为后面所有开发提供稳定基座。

### [P1-T01] 梳理核心域模型与 JSON Manifest 结构

- 从设计文档中整理出所有核心概念：
   `Project / Blackboard / StageTree / Stage / PuzzleNode / FSM(State, Transition) / PresentationGraph / Script / Variable / Event / ResourceState(Draft/Implemented/MarkedForDelete)`。
- 设计一个顶层 JSON Manifest 结构，确定这些对象之间的嵌套关系和引用方式（例如通过 ID 引用）。
- 明确哪些数据在一个工程中是「唯一的」（如 Script 定义）、哪些是可以在多处实例化的（如 PuzzleNode）。

### [P1-T02] 定义 ID、Key 与引用规则

- 设计每类资源的 ID/Key 命名规范（如：是否全局唯一、是否带类型前缀、是否稳定不随重命名变化）。
- 定义引用行为：
  - 引用 Script / Variable / Event 时使用什么字段（例如 `refId` 或 `refKey`）。
  - 如何在 JSON 中区分“定义”和“引用”。
- 考虑未来支持重命名时，如何保证引用不失效（例如依赖内部 ID 而非显示 Name）。

### [P1-T03] 资源生命周期与软删除状态机设计

- 根据文档中 Draft → Implemented → MarkedForDelete 的要求，画出资源状态机：允许/禁止的状态转换和触发条件。
- 规定每个状态在 UI 上的表现和行为限制：
  - `Draft`：允许修改和物理删除；
  - `Implemented`：不允许物理删除，只能标记删除；
  - `MarkedForDelete`：禁止新引用，旧引用要报红，但数据仍存在。在校验阶段会阻止导出仍引用该对象的工程；
- 定义“应用删除”操作的语义：执行后 JSON 中如何真正移除对象，以及如何在校验阶段阻止导出仍引用被删除对象的工程。

### [P1-T04] 作用域模型设计（Global / Stage Local / Node Local / Temporary）

- 定义变量在不同作用域中的**声明位置、可见范围和存档策略**：
  - Global：工程唯一，任何地方可见；
  - Stage Local：只在该 Stage 及其子结构可见；
  - Node Local：只在具体 PuzzleNode 内 FSM 与演出子图可见；
  - Temporary：仅在参数传递时存在。
- 设计 JSON 表达方式：每个 Stage / PuzzleNode 如何持有自己的局部变量列表；引用时如何带上作用域信息。
- 约定变量类型体系（数字、布尔、字符串、枚举等）及允许的比较/运算类型。

### [P1-T05] 条件构造器与参数修改器的抽象模型

- 抽象出一个通用的「条件表达式」结构，可以组合：
  - 变量比较（Var op Value）；
  - 调用自定义条件脚本；
  - AND/OR 嵌套组。
- 抽象出参数修改操作的通用结构：
  - 操作类型（Set / Add / Sub / CopyFromVar 等）；
  - 目标变量作用域；
  - 值来源（常量 / 变量引用）。
- 这些抽象在 JSON 中统一表达，以便在 Stage 解锁条件、Transition、事件监听等处复用。

### [P1-T06] 事件与触发器模型设计

- 统一定义 Event 的结构（ID、Name、Description、State）。
- 定义触发器类型集合：`Always / OnEvent / CustomScript`，约定每一类需要的配置字段。
- 明确 Event 在哪些层级可被监听（Stage、State、PuzzleNode、演出图节点）以及监听行为可以驱动哪些动作（调用脚本 / 修改参数 / 状态转移等）。

### [P1-T07] 演出体系与参数传递模型设计

- 抽象 **PresentationGraph** 结构：节点列表、连线关系、每个节点绑定的演出脚本引用。
- 定义在 Stage / State / Transition / GraphNode 任意位置绑定“一个演出对象（脚本或子图）”时 JSON 的统一格式。
- 设计参数传递结构：
  - 支持从 Global / Stage / Node 变量读取；
  - 支持定义一次性的临时参数并作为脚本入参。

### [P1-T08] 应用分层与模块边界设计

- 划分前端应用的主要模块：
  - 数据 Store（持有完整 JSON 状态树）；
  - 域服务层（加载/保存/校验/查询引用等）；
  - 视图层组件（StageTree、Canvas、Inspector、Blackboard 视图等）；
  - 通用交互组件（ScriptPicker、ConditionBuilder、ParamEditor 等）。
- 定义各模块之间的依赖关系和数据流向（单向更新，避免循环依赖）。

### [P1-T09] 基础交互规范与快捷键约定

- 统一所有编辑视图的基础操作体验：
  - 选中/多选/框选；
  - 右键上下文菜单；
  - 删除/复制/粘贴；
  - 画布平移与缩放的手势和快捷键。
- 设计全局快捷键（如保存/撤销/重做）以及与画布局部快捷键的优先级规则。

------

## 阶段二：核心浏览与只读展示

> 目标：在没有任何编辑能力的前提下，先让策划「可以打开一个工程，完整地浏览所有数据结构和关系」。

### [P2-T01] 项目加载与内存模型构建

- 实现从 JSON Manifest 加载工程的流程。
- 将 JSON 解析为内部统一的数据结构并注入到 Store 中，包含：Blackboard、StageTree、PuzzleNodes、FSM、PresentationGraphs 等。
- 处理版本字段和简单的兼容逻辑（例如旧字段缺省时填默认值）。

### [P2-T02] 顶层导航框架与路由

- 搭建顶层布局：顶部栏 + 左侧阶段树 + 中间工作区 + 右侧 Inspector。
- 实现路由与视图切换规则：
  - 在 Stage 树中选择不同 Stage；
  - 双击 PuzzleNode 进入 FSM 画布视图；
  - 打开某一个 PresentationGraph 的独立视图；
  - 面包屑同步更新并支持回退到上一级。

### [P2-T03] 阶段树只读视图

- 从 Store 渲染完整的阶段树层级结构。
- 支持展开/折叠、当前选中高亮、标记初始 Stage。
- 点击树节点时，中间工作区切换为该 Stage 的“内容概览”页面。

### [P2-T04] Stage 内容概览只读视图

- 在中间工作区，用卡片方式列出：
  - 当前 Stage 的子 Stage 列表；
  - 当前 Stage 下的 PuzzleNode 列表。
- 单击卡片：
  - 若为 Stage 卡片：在右侧 Inspector 显示 Stage 属性（只读）。
  - 若为 PuzzleNode 卡片：在右侧 Inspector 显示 PuzzleNode 的基本属性（只读）。
- 双击 PuzzleNode 卡片：跳转到该节点的 FSM 画布视图。

### [P2-T05] Blackboard 只读视图（变量/脚本/事件）

- 实现黑板视图三页签：变量、脚本、事件，只读状态。
- 支持按名称、类型、State 状态筛选和搜索。
- 点击任一条目，在侧边或 Inspector 中展示详细信息，但暂时不支持编辑。

### [P2-T06] PuzzleNode FSM 画布只读视图

- 实现无限画布，支持平移和缩放。
- 根据 FSM 数据渲染所有 State 节点和 Transition 连线：
  - 显示节点名称、是否初始状态；
  - 显示连线方向以及简要的触发条件标签。
- 允许点击节点/连线，右侧 Inspector 切换显示对应的详细属性（只读）。

### [P2-T07] 演出子图（PresentationGraph）只读视图

- 列出所有定义的 PresentationGraph，并能打开单个图查看：
  - 节点列表与连线结构；
  - 每个节点绑定的演出脚本及简单参数摘要。
- 同样只读，不支持结构修改。

### [P2-T08] 基础保存与导出（无校验）

- 实现最基础的「保存」与「导出」操作：
  - 将当前内存模型序列化回 JSON；
  - 未做复杂校验，只要求保持结构完整、字段不丢失。
- 确认“加载→无修改→导出”的结果与原始 JSON 在语义上一致。

------

## 阶段三：核心编辑功能（解谜节点内部复杂逻辑）

> 目标：在已经能浏览的基础上，优先让策划可以 **完整编辑单个 PuzzleNode 的内部状态机和事件逻辑**。

### [P3-T01] PuzzleNode 局部变量的增删改

- 在进入某个 PuzzleNode 的 FSM 画布时，提供 Node Local Variables 管理面板。
- 支持创建、重命名、修改类型、修改默认值和删除局部变量。
- 校验局部变量名称唯一性，并在删除时检查是否被 FSM/演出引用，必要时给出警告。

### [P3-T02] 状态节点的编辑操作

- 在 FSM 画布上支持：
  - 新建 State 节点；
  - 修改名称和描述；
  - 设置/更换初始 State；
  - 拖拽重新布局；
  - 删除 State（若存在相关连线，需要相应删除或提示）。
- 将这些操作与 Store 的数据更新连接起来，并保持可撤销/重做。

### [P3-T03] 状态节点生命周期与事件监听配置

- 在选中 State 节点时，右侧 Inspector 提供：
  - 绑定/解绑生命周期脚本；
  - 配置事件监听列表：每条监听记录包括 Event 引用、处理动作（调用脚本或参数修改器）。
- 引用脚本和变量时仅使用黑板中已定义的条目或者局部可见的变量，不支持在此处新建黑板资源。

### [P3-T04] 连线创建、删除与基本属性编辑

- 在画布上支持通过拖拽或右键菜单创建 Transition 连线，并支持删除。
- 在 Inspector 中展示 Transition 的基本信息：来源状态、目标状态、名称或备注字段。
- 允许自环连线。

### [P3-T05] 触发器编辑（Triggers）

- 为 Transition 提供专门的触发器编辑区域：
  - 允许添加多条触发器记录；
  - 支持选择触发器类型：Always / OnEvent / CustomScript；
  - 若为 OnEvent：提供事件选择器；
  - 若为 CustomScript：提供自定义触发脚本选择器。
- 校验：当 Transition 没有任何触发器且也没有强制执行逻辑时，在后续校验阶段产生警告。

### [P3-T06] 条件构造器编辑（Condition Builder）

- 在 Transition Inspector 中集成完整的条件构造 UI：
  - 支持添加变量条件（选择作用域、变量名、比较操作、比较值）；
  - 支持添加自定义条件脚本引用；
  - 支持 AND/OR 组合以及分组嵌套。
- 变量选择器复用现有逻辑

### [P3-T07] 参数修改器配置（Parameter Modifier）

- 允许在 Transition 上配置一组“执行时修改参数”的操作：
  - 每条操作包括：目标变量作用域、变量名、操作类型、值来源（常量或变量引用）。
- 同样复用之前抽象好的参数修改结构，为后续 Stage/事件监听等处的复用打基础。

### [P3-T08] 演出绑定与参数传递（Transition / State）

- 允许在 Transition 和 State 上各自绑定一个演出对象（脚本或子图），并配置参数传递。
- 参数传递编辑 UI：
  - 一行一条参数映射：`目标参数名 = 来源（常量 / 变量引用 / 临时参数）`；
  - 支持创建临时参数并立即作为来源。

### [P3-T09] 画布编辑体验 & 基础校验

- 为 FSM 画布补齐完整的交互：框选、多选、批量移动等。
- 实现局部即时校验：
  - 存在引用已删除资源时在节点/连线上显示错误标记。
- 保证编辑与撤销/重做机制正确工作。

------

## 阶段四：全局系统与工作流完善

> 目标：让策划可以围绕「整个工程」流畅工作：管理黑板、阶段树、演出图，串联成自然的工作流。

### [P4-T01] 黑板资源全功能编辑（变量/脚本/事件）

- 在 Blackboard 视图中开放完整编辑能力：
  - 新建、删除、重命名、编辑功能（不可以编辑状态和ID，状态由系统管理，ID由系统自动生成）；、
  - ID的生成逻辑采用 “资源类型_资源计数”的命名规则。
  - 删除逻辑遵循软删除规则，并提供“应用删除”操作。
- 实现“引用查询”：在黑板条目详情中列出所有引用位置（Stage / Node / Transition / 演出节点等），点击可跳转。

### [P4-T02] 阶段树编辑（Stage Tree Editing）

- 在 Stage 层级视图中支持：
  - 新建 Stage（作为子节点或同级节点）、删除Stage；
    - 如果Stage内有子Stage或者PuzzleNode，删除这个Stage需要弹窗提示（复用现有的弹窗确认脚本）
  - 调整父子关系和顺序（拖拽改变层级）；
  - Stage 节点下的第一个子Stage为这个阶段的初始子 Stage，没有解锁条件。
- 在 Stage Inspector 中开放以下编辑：
  - 重命名、调整描述；
  - 管理 Stage Local Variables（与PuzzleNode逻辑一致）；
  - 通过条件构造器配置解锁条件（已实现）；
  - 绑定 Stage 生命周期脚本（已实现）；
  - 配置 Stage 级别演出和事件监听（已实现）。

- Stage的Inspector界面与目前已经实现的PuzzleNode/State/Transition的Inspector界面UI风格统一

### [P4-T03] 解谜节点实体级编辑（PuzzleNode 实体）

- 在 Explorer层级视图的Nodes视图下支持：
  - 右键菜单【新建Node、删除Node、重命名Node】
    - 逻辑和 Explorer 层级下的Stages视图一致
  - 拖拽Node改变上下排列

- 在 Stage 内容概览视图中支持：
  - 新建 子Stage (与阶段树中创建逻辑一致，只是在内容视图中也支持创建)
  - 新建 PuzzleNode 卡片（选择节点类型）；
  - 删除节点/Stage；

- 在 PuzzleNode Inspector 中开放：
  - 删除按钮（跟Stage Inspector一致），如果PuzzleNode有不止一个节点就会在删除前弹窗提示。
  - 节点基本信息编辑（跟Stage Inspector一致），编辑Name和Description；
  - 节点生命周期脚本绑定（已开放）；
  - 节点级事件监听和参数修改配置（已开放）。
  

### [P4-T04] 演出子图编辑器完善

- 为 PresentationGraph 提供完整编辑能力：
  - 在图中新增节点、连线、调整顺序；
  - 为脚本节点绑定演出脚本并配置参数传递（与FSM Transition配置演出脚本的逻辑一致）。
- 支持从其他位置跳转到对应的演出图。

### [P4-T05] 跨视图导航与工作流打通

- 在所有引用黑板资源的地方（变量选择器、脚本选择器、事件选择器），提供「查看定义」「跳转到定义」操作。
- 在错误/警告列表中点击某一项，能够定位到对应的 Stage / Node / Transition / Blackboard 条目，并自动高亮。
- 优化面包屑与左侧树之间的联动，保证不出现“迷路”状态。

### [P4-T06] 项目级操作与多工程支持（基础）

- 定义并实现「新建工程」「打开工程」「工程元信息编辑（名称、备注、版本）」等功能。
- 允许在同一会话内切换不同工程（可以先从简单实现开始，例如一次只加载一个工程，切换时确认保存）。
- 为工程保存引入版本号或简单变更记录字段，为后续兼容与迁移做准备。

------

## 阶段五：校验、体验优化与交付

> 目标：让编辑器变得“可靠 + 好用”，并真正可以产出可交付给 Unity 的配置。

### [P5-T01] 校验规则体系设计与实现

- 汇总需要的校验规则，至少包括：
  - 引用的 Script/Variable/Event 是否存在且未处于 MarkedForDelete；
  - PuzzleNode 的 FSM 是否有初始状态；
  - 存在自指或死循环但没有任何退出路径时给出警告；
  - 条件中变量类型是否与比较操作兼容；
  - 参数修改是否在可见作用域内操作变量。
- 将这些规则实现为可组合的校验模块，支持在导出前统一执行。

### [P5-T02] 校验触发时机与错误级别

- 设计多种校验触发方式：
  - 手动点击“校验工程”；
  - 导出前强制校验，错误时阻止导出；
  - 局部编辑时的即时轻量校验（如字段留空、类型不匹配）。
- 定义错误级别：Error / Warning / Hint，并在 UI 中体现不同严重程度。

### [P5-T03] 校验结果展示与修复工作流

- 实现一个全局“问题列表”视图，按照资源类型和严重程度分类展示。
- 每条问题记录应包含：简要描述 + 具体位置 + 快速跳转按钮。
- 在局部视图中也要体现错误，比如：
  - 阶段树节点标红；
  - FSM 画布中的节点/连线高亮错误图标；
  - Blackboard 条目显示警告标记。

### [P5-T04] 性能调优与大工程体验优化

- 在典型“大工程”场景下测试：很多 Stage、很多 PuzzleNode、单个 FSM 含大量状态和连线。
- 识别性能瓶颈（例如大画布渲染、频繁重绘、复杂搜索）并优化数据更新和渲染策略。
- 确保画布交互在较大规模下依然流畅，滚动和缩放不明显卡顿。

### [P5-T05] 使用体验打磨（UX Polish）

- 增加快捷操作：
  - 键盘快捷键（复制/粘贴/对齐/新建节点等）；
  - 常用功能的工具栏按钮。
- 增加新手引导与内联提示：
  - 首次打开工程时展示核心概念说明；
  - 在空白画布上显示“如何创建第一个状态/连线”的提示；
  - 在条件/参数编辑器里提供示例和说明文本。
- 增加「撤销提示」和「危险操作确认」（如应用删除）。

### [P5-T06] 示例工程与文档整理

- 基于《叙事解谜》第一阶段谜题（闪电骰面、商店、电脑、软盘等）先构建一个完整的示例工程，覆盖所有关键功能链路。叙事解谜
- 编写用户向文档：
  - 如何从零创建一个 Stage Tree；
  - 如何搭建一个 PuzzleNode 的完整状态机；
  - 如何配置演出和参数；
  - 如何导出并对接到 Unity 工程中。

### [P5-T07] 导出规范最终定稿与对接准备

- 根据 Unity 侧需求，最终确认 JSON Manifest 的字段命名、结构、版本字段等细节。
- 给出简单的“导出契约文档”，描述：
  - 各个结构在 Unity 中应该被解析成什么对象；
  - 哪些字段是必填，哪些是可选；
  - 出错时 Unity 侧应该如何报错。
