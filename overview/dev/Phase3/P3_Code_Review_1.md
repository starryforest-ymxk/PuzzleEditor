# Phase3 ä»£ç å®¡æŸ¥æŠ¥å‘Šï¼ˆP3_Code_Review_1ï¼‰

> **ç‰ˆæœ¬**ï¼š1.0.0  
> **å®¡æŸ¥æ—¥æœŸ**ï¼š2025-12-14  
> **å®¡æŸ¥èŒƒå›´**ï¼šé˜¶æ®µä¸‰ï¼ˆP3-T01 ~ P3-T09ï¼‰æ ¸å¿ƒç¼–è¾‘åŠŸèƒ½å®ç°

---

## ä¸€ã€æ ¸å¿ƒç›®æ ‡è¾¾æˆæƒ…å†µ

### ç›®æ ‡å®šä¹‰
> åœ¨å·²ç»èƒ½æµè§ˆçš„åŸºç¡€ä¸Šï¼Œä¼˜å…ˆè®©ç­–åˆ’å¯ä»¥ **å®Œæ•´ç¼–è¾‘å•ä¸ª PuzzleNode çš„å†…éƒ¨çŠ¶æ€æœºå’Œäº‹ä»¶é€»è¾‘**

### è¾¾æˆè¯„ä¼°ï¼šâœ… åŸºæœ¬è¾¾æˆ

| ä»»åŠ¡ç¼–å· | ä»»åŠ¡åç§° | å®ŒæˆçŠ¶æ€ | è¯´æ˜ |
|---------|---------|---------|------|
| P3-T01 | PuzzleNode å±€éƒ¨å˜é‡çš„å¢åˆ æ”¹ | âœ… å®Œæˆ | `LocalVariableEditor` æ”¯æŒæ–°å¢/é‡å‘½å/ç±»å‹åˆ‡æ¢/åˆ é™¤ï¼Œå«å¼•ç”¨æ£€æŸ¥ä¸è½¯åˆ äºŒæ®µç¡®è®¤ |
| P3-T02 | çŠ¶æ€èŠ‚ç‚¹çš„ç¼–è¾‘æ“ä½œ | âœ… å®Œæˆ | æ”¯æŒæ–°å»º/åˆ é™¤/é‡å‘½å/æ‹–æ‹½/è®¾ç½®åˆå§‹çŠ¶æ€ï¼Œæ’¤é”€é‡åšæ­£å¸¸ |
| P3-T03 | çŠ¶æ€ç”Ÿå‘½å‘¨æœŸä¸äº‹ä»¶ç›‘å¬é…ç½® | âœ… å®Œæˆ | `StateInspector` æ”¯æŒè„šæœ¬ç»‘å®šä¸äº‹ä»¶ç›‘å¬å™¨ç¼–è¾‘ |
| P3-T04 | è¿çº¿åˆ›å»ºã€åˆ é™¤ä¸åŸºæœ¬å±æ€§ç¼–è¾‘ | âœ… å®Œæˆ | æ”¯æŒ Shift+æ‹–æ‹½/å³é”®èœå•åˆ›å»ºè¿çº¿ï¼Œé‡å¤è¾¹ä¿æŠ¤ï¼Œè‡ªç¯æ”¯æŒ |
| P3-T05 | è§¦å‘å™¨ç¼–è¾‘ | âœ… å®Œæˆ | `TriggerEditor` æ”¯æŒ Always/OnEvent/CustomScript å¤šæ¡è§¦å‘å™¨ |
| P3-T06 | æ¡ä»¶æ„é€ å™¨ç¼–è¾‘ | âœ… å®Œæˆ | `ConditionEditor` æ”¯æŒå˜é‡æ¯”è¾ƒã€è„šæœ¬å¼•ç”¨ã€AND/OR/NOT åµŒå¥— |
| P3-T07 | å‚æ•°ä¿®æ”¹å™¨é…ç½® | âœ… å®Œæˆ | `ParameterModifierEditor` æ”¯æŒç›®æ ‡å˜é‡/æ“ä½œ/å€¼æ¥æºé…ç½® |
| P3-T08 | æ¼”å‡ºç»‘å®šä¸å‚æ•°ä¼ é€’ | âœ… å®Œæˆ | `PresentationBindingEditor` æ”¯æŒè„šæœ¬/å­å›¾ç»‘å®šä¸ä¸´æ—¶å‚æ•° |
| P3-T09 | ç”»å¸ƒç¼–è¾‘ä½“éªŒ & åŸºç¡€æ ¡éªŒ | âœ… å®Œæˆ | æ¡†é€‰/å¤šé€‰/æ‰¹é‡ç§»åŠ¨/Ctrlå‰ªçº¿/è½¯åˆ èµ„æºæ ¡éªŒ/é”™è¯¯æ ‡è®° |

---

## äºŒã€ä»£ç æ¶æ„è¯„ä¼°

### 2.1 æ•´ä½“æ¶æ„

**ä¼˜ç‚¹ï¼š**
- âœ… **Slice æ‹†åˆ†æ¸…æ™°**ï¼š`fsmSlice`ã€`nodeParamsSlice`ã€`presentationSlice` ç­‰èŒè´£åˆ†æ˜
- âœ… **ç±»å‹ç³»ç»Ÿå®Œå–„**ï¼š`types/` ç›®å½•å®šä¹‰äº†å®Œæ•´çš„é¢†åŸŸæ¨¡å‹ï¼ˆStateã€Transitionã€ConditionExpression ç­‰ï¼‰
- âœ… **æ’¤é”€é‡åšæœºåˆ¶**ï¼š`reducer.ts` ä¸­çš„ History Wrapper ç»Ÿä¸€ç®¡ç†ï¼ŒAction ç™½åå•æ§åˆ¶
- âœ… **ç»„ä»¶å¤ç”¨è‰¯å¥½**ï¼š`ResourceSelect`ã€`VariableSelector`ã€`ValueSourceEditor` ç­‰é€šç”¨ç»„ä»¶æŠ½ç¦»

**æ¶æ„å›¾ï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          UI Layer                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Canvas       â”‚  â”‚ Inspector    â”‚  â”‚ Blackboard           â”‚  â”‚
â”‚  â”‚ - FSM        â”‚  â”‚ - State      â”‚  â”‚ - Variables/Scripts  â”‚  â”‚
â”‚  â”‚ - Presentationâ”‚ â”‚ - Transition â”‚  â”‚ - Events/Graphs      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Store Layer                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ fsmSlice â”‚ â”‚nodeParamsâ”‚ â”‚blackboardâ”‚ â”‚ uiSlice  â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                    â†“ reducer.ts (History Wrapper)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Types Layer                              â”‚
â”‚  stateMachine.ts â”‚ common.ts â”‚ blackboard.ts â”‚ puzzleNode.ts    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ç»„ä»¶ç»“æ„åˆ†æ

| ç»„ä»¶ç±»åˆ« | æ ¸å¿ƒæ–‡ä»¶ | ä»£ç è¡Œæ•° | è¯„ä»· |
|---------|---------|---------|------|
| Canvas ç”»å¸ƒ | `StateMachineCanvas.tsx` | 657 | âš ï¸ æ–‡ä»¶è¿‡å¤§ï¼Œå»ºè®®æ‹†åˆ† |
| Inspector é¢æ¿ | `TransitionInspector.tsx` | 243 | âœ… é€‚ä¸­ |
| æ¡ä»¶ç¼–è¾‘å™¨ | `condition/ConditionEditor.tsx` | 632 | âš ï¸ å¤æ‚åº¦è¾ƒé«˜ |
| å±€éƒ¨å˜é‡ | `LocalVariableEditor.tsx` | 487 | âœ… é€»è¾‘å®Œæ•´ |
| æ¼”å‡ºç»‘å®š | `PresentationBindingEditor.tsx` | 509 | âš ï¸ å¯æ‹†åˆ† |

---

## ä¸‰ã€å‘ç°çš„é—®é¢˜ä¸æ”¹è¿›å»ºè®®

### 3.1 ğŸŸ¢ å·²ä¿®å¤é—®é¢˜

#### é—®é¢˜ 1ï¼šStateMachineCanvas.tsx æ–‡ä»¶è¿‡å¤§ï¼ˆ657 è¡Œï¼‰âœ… å·²ä¿®å¤

**åŸçŠ¶å†µ**ï¼šåŒ…å«ç”»å¸ƒæ¸²æŸ“ã€äº¤äº’é€»è¾‘ã€äº‹ä»¶å¤„ç†ã€æ ¡éªŒé›†æˆç­‰å¤šé‡èŒè´£

**ä¿®å¤æ–¹æ¡ˆ**ï¼šå·²å°† 657 è¡Œæ‹†åˆ†ä¸ºä»¥ä¸‹æ¨¡å—ï¼š

**æ–°å¢ Hooksï¼ˆ`hooks/` ç›®å½•ï¼‰ï¼š**
- `useCuttingLine.ts` - Ctrl+æ‹–æ‹½å‰ªçº¿é€»è¾‘ï¼ˆ~150 è¡Œï¼‰
- `useKeyboardShortcuts.ts` - é”®ç›˜å¿«æ·é”®å¤„ç†ï¼ˆ~95 è¡Œï¼‰
- `useStateNodeInteraction.ts` - çŠ¶æ€èŠ‚ç‚¹äº¤äº’é€»è¾‘ï¼ˆ~170 è¡Œï¼‰

**æ–°å¢ Layer ç»„ä»¶ï¼ˆ`components/Canvas/Elements/` ç›®å½•ï¼‰ï¼š**
- `TransitionsLayer.tsx` - è¿çº¿æ¸²æŸ“å±‚ï¼ˆSVG + HTML æ§ä»¶ï¼‰ï¼ˆ~250 è¡Œï¼‰
- `StatesLayer.tsx` - çŠ¶æ€èŠ‚ç‚¹æ¸²æŸ“å±‚ï¼ˆ~75 è¡Œï¼‰

**é‡æ„åä¸»æ–‡ä»¶**ï¼š
- `StateMachineCanvas.tsx` ä» 657 è¡Œå‡å°‘åˆ°çº¦ 400 è¡Œ

**éªŒè¯ç»“æœ**ï¼šâœ… å·²é€šè¿‡æµè§ˆå™¨æµ‹è¯•ï¼ŒFSM ç”»å¸ƒåŠŸèƒ½æ­£å¸¸è¿è¡Œ

#### é—®é¢˜ 2ï¼šéƒ¨åˆ†ç»„ä»¶å†…è”æ ·å¼è¿‡å¤š âœ… å·²ä¿®å¤

**åŸçŠ¶å†µ**ï¼š`StateInspector.tsx`ã€`TransitionInspector.tsx` ç­‰å¤§é‡ä½¿ç”¨ `style={{...}}`

**ä¿®å¤æ–¹æ¡ˆ**ï¼š

**æ–°å¢ CSS ç±»ï¼ˆ`styles.css`ï¼Œ+200 è¡Œï¼‰ï¼š**
- `.inspector-header-panel` - é¡¶éƒ¨å¤´éƒ¨åŒºåŸŸ
- `.inspector-type-label` - å®ä½“ç±»å‹æ ‡ç­¾ï¼ˆå« --state/--transition/--node å˜ä½“ï¼‰
- `.inspector-name-input` - åç§°è¾“å…¥æ¡†
- `.inspector-section` / `.inspector-section-title` - Section åŒºå—
- `.inspector-readonly-wrapper` - åªè¯»æ¨¡å¼åŒ…è£…å™¨
- `.inspector-initial-badge` / `.inspector-set-initial-btn` - åˆå§‹çŠ¶æ€ UI
- `.inspector-textarea` / `.inspector-number-input` - è¡¨å•æ§ä»¶
- `.inspector-modifier-card` - ä¿®æ”¹å™¨å¡ç‰‡
- `.inspector-list-container` / `.inspector-empty-hint` - åˆ—è¡¨å®¹å™¨
- `.btn-remove-text` - åˆ é™¤æ–‡å­—æŒ‰é’®

**é‡æ„åç»„ä»¶**ï¼š
- `StateInspector.tsx` - ä» 165 è¡Œå‡å°‘åˆ° ~160 è¡Œï¼Œç§»é™¤æ‰€æœ‰ `style={{...}}`
- `TransitionInspector.tsx` - ä» 243 è¡Œå‡å°‘åˆ° ~235 è¡Œï¼Œç§»é™¤æ‰€æœ‰ `style={{...}}`

**éªŒè¯ç»“æœ**ï¼šâœ… å·²é€šè¿‡æµè§ˆå™¨æµ‹è¯•ï¼ŒInspector é¢æ¿æ ·å¼æ­£å¸¸

#### é—®é¢˜ 3ï¼šç¼ºå°‘è¾“å…¥æ ¡éªŒçš„å³æ—¶åé¦ˆ â³ éƒ¨åˆ†å®Œæˆ / å»¶åå¤„ç†

**ç°çŠ¶**ï¼š
- âœ… Transition æ— è§¦å‘å™¨æ—¶å·²åœ¨ Inspector æ˜¾ç¤ºè­¦å‘Š
- â³ é€šç”¨è¾“å…¥å­—æ®µæ ¡éªŒï¼ˆå¦‚ Priorityã€eventId ä¸ºç©ºç­‰ï¼‰ç•™å¾…åç»­é˜¶æ®µç»Ÿä¸€å¤„ç†

**è¯´æ˜**ï¼šç»Ÿä¸€æ ¡éªŒæœºåˆ¶å°†åœ¨åç»­é˜¶æ®µä½œä¸ºæ•´ä½“æ¶æ„æ”¹è¿›æ¥å®ç°

---

### 3.2 ğŸŸ¡ ä¸­ä¼˜å…ˆçº§é—®é¢˜

#### é—®é¢˜ 4ï¼šç±»å‹å®šä¹‰ä¸­å­˜åœ¨å†—ä½™å­—æ®µ âœ… å·²ä¿®å¤

**åŸä½ç½®**ï¼š`types/stateMachine.ts` State æ¥å£

**ä¿®å¤æ–¹æ¡ˆ**ï¼šç›´æ¥ç§»é™¤æœªä½¿ç”¨çš„ `onEnterScriptId` å’Œ `onExitScriptId` å­—æ®µ

**ä¿®æ”¹çš„æ–‡ä»¶**ï¼š
- `types/stateMachine.ts` - ç§»é™¤å†—ä½™å­—æ®µ
- `utils/fsmValidation.ts` - ç§»é™¤å¯¹åº”çš„æ ¡éªŒé€»è¾‘
- `api/mockData.ts` - å°† `onEnterScriptId` æ”¹ä¸º `lifecycleScriptId`
- `overview/dev/Domain_Model.md` - æ›´æ–°æ–‡æ¡£

#### é—®é¢˜ 5ï¼šæ ¡éªŒé€»è¾‘åˆ†æ•£ âœ… å·²ä¿®å¤

**åŸçŠ¶å†µ**ï¼š
- ç”»å¸ƒçº§æ ¡éªŒï¼š`utils/fsmValidation.ts`
- å˜é‡å¼•ç”¨æ£€æŸ¥ï¼š`utils/variableReferences.ts`
- å±€éƒ¨å˜é‡æ ¡éªŒï¼š`LocalVariableEditor.tsx` å†…éƒ¨

**ä¿®å¤æ–¹æ¡ˆ**ï¼šå»ºç«‹ `utils/validation/` ç»Ÿä¸€æ ¡éªŒæ¨¡å—ç›®å½•

**æ–°å¢/ä¿®æ”¹çš„æ–‡ä»¶**ï¼š
- `utils/validation/types.ts` - é€šç”¨æ ¡éªŒç±»å‹å®šä¹‰ï¼ˆ`ValidationResult`ã€`ValidationIssue`ã€`Validator` æ¥å£ï¼‰
- `utils/validation/variableValidation.ts` - å˜é‡æ ¡éªŒå·¥å…·ï¼ˆåç§°å†²çªæ£€æµ‹ã€å€¼ç±»å‹æ ¡éªŒï¼‰
- `utils/validation/fsmValidation.ts` - FSM æ ¡éªŒï¼ˆä» `utils/` è¿ç§»ï¼‰
- `utils/validation/variableReferences.ts` - å˜é‡å¼•ç”¨è¿½è¸ªï¼ˆä» `utils/` è¿ç§»ï¼‰
- `utils/validation/index.ts` - ç»Ÿä¸€å¯¼å‡ºå…¥å£
- `utils/fsmValidation.ts` - å…¼å®¹æ€§é‡å¯¼å‡º
- `utils/variableReferences.ts` - å…¼å®¹æ€§é‡å¯¼å‡º

**éªŒè¯ç»“æœ**ï¼šâœ… Vite å¼€å‘æœåŠ¡å™¨æ­£å¸¸å¯åŠ¨ï¼Œç°æœ‰åŠŸèƒ½å…¼å®¹

#### é—®é¢˜ 6ï¼šäº‹ä»¶ç›‘å¬å™¨ InvokeScript è¯­ä¹‰ä¸å¤Ÿæ¸…æ™° âœ… å·²ä¿®å¤

**åŸçŠ¶å†µ**ï¼š`types/common.ts` ä¸­ `InvokeScript` ä¿ç•™äº†ä¸å¿…è¦çš„å¯é€‰å­—æ®µ

```typescript
// æ—§ä»£ç 
export type EventAction =
  | {
    type: 'InvokeScript';
    scriptId?: ScriptId;      // ä¸éœ€è¦çš„å¯é€‰å­—æ®µ
    parameters?: ParameterBinding[];  // ä¸éœ€è¦çš„å¯é€‰å­—æ®µ
  }
```

**ä¿®å¤æ–¹æ¡ˆ**ï¼šç®€åŒ–ç±»å‹å®šä¹‰ï¼Œæ·»åŠ æ¸…æ™°çš„è¯­ä¹‰æ³¨é‡Š

```typescript
// æ–°ä»£ç 
/**
 * - InvokeScript: è°ƒç”¨å½“å‰å¯¹è±¡ï¼ˆState/Node/Stageï¼‰ç»‘å®šçš„ç”Ÿå‘½å‘¨æœŸè„šæœ¬çš„ OnEventInvoke å…¥å£
 * - ModifyParameter: ç›´æ¥ä¿®æ”¹æŒ‡å®šå˜é‡çš„å€¼
 */
export type EventAction =
  | { type: 'InvokeScript' }
  | { type: 'ModifyParameter'; modifiers: ParameterModifier[] };
```

**ä¿®æ”¹çš„æ–‡ä»¶**ï¼š
- `types/common.ts` - ç®€åŒ– EventAction ç±»å‹
- `utils/validation/fsmValidation.ts` - ç§»é™¤å¯¹ scriptId çš„æ ¡éªŒ
- `utils/validation/variableReferences.ts` - ç§»é™¤å¯¹ parameters çš„å¼•ç”¨æ”¶é›†

**éªŒè¯ç»“æœ**ï¼šâœ… Vite å¼€å‘æœåŠ¡å™¨æ­£å¸¸å¯åŠ¨

---

### 3.3 ğŸŸ¢ ä½ä¼˜å…ˆçº§/å»ºè®®æ€§æ”¹è¿›

#### é—®é¢˜ 7ï¼šéƒ¨åˆ†ç»„ä»¶ç¼ºå°‘ React.memo ä¼˜åŒ– âœ… å·²ä¿®å¤

**æ¶‰åŠç»„ä»¶**ï¼š
- `StateNode.tsx` - âœ… å·²ä½¿ç”¨ `React.memo`
- `ConnectionLine.tsx` - âœ… å·²ä½¿ç”¨ `React.memo`
- `ConnectionControls` - âœ… å·²ä½¿ç”¨ `React.memo`ï¼ˆä¸ ConnectionLine.tsx åŒæ–‡ä»¶ï¼‰

**éªŒè¯ç»“æœ**ï¼šæ‰€æœ‰ä¸‰ä¸ªç»„ä»¶å·²åœ¨å¼€å‘è¿‡ç¨‹ä¸­æ·»åŠ äº† `React.memo` ä¼˜åŒ–

#### é—®é¢˜ 8ï¼šMagic Numbers æœªå¸¸é‡åŒ– âœ… å·²ä¿®å¤

**ä¿®å¤æ–¹æ¡ˆ**ï¼šåˆ›å»º `utils/constants.ts` ç»Ÿä¸€ç®¡ç†äº¤äº’å¸¸é‡

```typescript
// utils/constants.ts
export const CANVAS = {
  SIZE: 4000,
  // ...
};

export const INTERACTION = {
  DRAG_THRESHOLD: 4,
  CLICK_THRESHOLD: 3,
  SNAP_DISTANCE: 20,
  // ...
};
```

**ä¿®æ”¹çš„æ–‡ä»¶**ï¼š
- `utils/constants.ts` - æ–°å¢ç»Ÿä¸€å¸¸é‡æ–‡ä»¶
- `StateMachineCanvas.tsx` - ä½¿ç”¨ `CANVAS.SIZE`ã€`INTERACTION.DRAG_THRESHOLD` ç­‰

#### é—®é¢˜ 9ï¼šæ—¥å¿—ä¸è°ƒè¯•ä¿¡æ¯ç¼ºå¤± âœ… å·²ä¿®å¤

**ä¿®å¤æ–¹æ¡ˆ**ï¼šåˆ›å»º `utils/debug.ts` æä¾› dev-only æ—¥å¿—å·¥å…·

```typescript
// utils/debug.ts
export function devLog(tag: LogTag, message: string, data?: unknown): void;
export function devWarn(tag: LogTag, message: string, data?: unknown): void;
export function createLogger(tag: LogTag): { log, warn, error };
```

**ä¿®æ”¹çš„æ–‡ä»¶**ï¼š
- `utils/debug.ts` - æ–°å¢è°ƒè¯•æ—¥å¿—å·¥å…·
- `hooks/useCuttingLine.ts` - æ·»åŠ å‰ªçº¿äº¤äº’æ—¥å¿—

---

## å››ã€ä»£ç è´¨é‡è¯„åˆ†

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|-----|-----|------|
| åŠŸèƒ½å®Œæ•´æ€§ | â­â­â­â­â­ | 9ä¸ªå­ä»»åŠ¡å…¨éƒ¨å®Œæˆ |
| ä»£ç å¯è¯»æ€§ | â­â­â­â­ | æ³¨é‡Šè¾ƒå¥½ï¼Œä½†éƒ¨åˆ†æ–‡ä»¶è¿‡é•¿ |
| æ¶æ„åˆç†æ€§ | â­â­â­â­ | Slice æ‹†åˆ†æ¸…æ™°ï¼Œç»„ä»¶ç•¥æœ‰è€¦åˆ |
| ç±»å‹å®‰å…¨æ€§ | â­â­â­â­â­ | TypeScript ä½¿ç”¨è§„èŒƒ |
| å¯ç»´æŠ¤æ€§ | â­â­â­â­ | éœ€æ‹†åˆ†å¤§æ–‡ä»¶ |
| æ€§èƒ½è€ƒé‡ | â­â­â­ | ç¼ºå°‘ memo/useMemo ä¼˜åŒ– |

**ç»¼åˆè¯„åˆ†**ï¼š**4.2 / 5**

---

## äº”ã€ä¸ UX_Flow.md å¯¹ç…§æ£€æŸ¥

| UX_Flow è¦æ±‚ | å®ç°çŠ¶æ€ | å¤‡æ³¨ |
|-------------|---------|------|
| FSM ç”»å¸ƒå¹³ç§»ï¼ˆSpace/ä¸­é”®/Altï¼‰ | âœ… | `useCanvasNavigation` |
| ç¼©æ”¾ï¼ˆCtrl+æ»šè½®ï¼‰ | âœ… | `useCanvasNavigation` |
| å³é”®èœå• Add State/Link/Delete | âœ… | `CanvasContextMenu` |
| Shift+æ‹–æ‹½åˆ›å»ºè¿çº¿ | âœ… | `startLinking` |
| Ctrl+æ‹–æ‹½åˆ‡æ–­è¿çº¿ | âœ… | `cuttingLine` çŠ¶æ€ |
| èŠ‚ç‚¹é€‰ä¸­è“è‰²è¾¹æ¡† | âœ… | `StateNode` isSelected |
| å¤šé€‰æ¡†é€‰ | âœ… | `boxSelectRect` |
| Inspector - State ç¼–è¾‘ | âœ… | `StateInspector` |
| Inspector - Transition ç¼–è¾‘ | âœ… | `TransitionInspector` |
| æ¡ä»¶æ„é€ å™¨ AND/OR | âœ… | `ConditionEditor` |
| å‚æ•°ä¿®æ”¹å™¨ Set/Add/Sub | âœ… | `ParameterModifierEditor` |
| æ¼”å‡ºç»‘å®šè„šæœ¬/å­å›¾ | âœ… | `PresentationBindingEditor` |
| ä¸´æ—¶å‚æ•°åˆ›å»º | âœ… | Temporary å‚æ•°æ”¯æŒ |
| è½¯åˆ é™¤èµ„æºçº¢æ ‡ | âœ… | `fsmValidation.ts` + UI æ ‡è®° |
| æ— åˆå§‹çŠ¶æ€è­¦å‘Š | âœ… | `CanvasInfoOverlay` |

---

## å…­ã€åç»­å»ºè®®

### çŸ­æœŸï¼ˆPhase3 æ”¶å°¾ï¼‰
1. âœ… æ‹†åˆ† `StateMachineCanvas.tsx` è‡³å¤šä¸ªå­æ¨¡å—ï¼ˆå·²å®Œæˆï¼‰
2. âœ… æŠ½å– Inspector é€šç”¨æ ·å¼åˆ° CSSï¼ˆå·²å®Œæˆï¼‰
3. âœ… Transition æ— è§¦å‘å™¨çš„ Inspector çº§è­¦å‘Šï¼ˆå·²å®Œæˆï¼‰

### ä¸­æœŸï¼ˆPhase4 å‡†å¤‡ï¼‰
1. âœ… ç»Ÿä¸€æ ¡éªŒæ¨¡å—æ¶æ„ï¼ˆå·²å®Œæˆï¼šé—®é¢˜5ä¿®å¤ï¼Œåˆ›å»º `utils/validation/` ç›®å½•ï¼‰
2. â¬œ æ·»åŠ  Stage å±€éƒ¨å˜é‡ç¼–è¾‘æ”¯æŒ
3. â¬œ å®Œå–„ PresentationGraph ç¼–è¾‘å™¨

### é•¿æœŸï¼ˆPhase5 ä¼˜åŒ–ï¼‰
1. â¬œ æ€§èƒ½ä¼˜åŒ–ï¼ˆReact.memoã€è™šæ‹ŸåŒ–ï¼‰
2. â¬œ å•å…ƒæµ‹è¯•è¦†ç›–æ ¸å¿ƒ Slice/å·¥å…·å‡½æ•°
3. â¬œ E2E æµ‹è¯•å…³é”®ç”¨æˆ·è·¯å¾„

---

## ä¸ƒã€ç»“è®º

Phase3 çš„æ ¸å¿ƒç›®æ ‡ **"å®Œæ•´ç¼–è¾‘å•ä¸ª PuzzleNode çš„å†…éƒ¨çŠ¶æ€æœºå’Œäº‹ä»¶é€»è¾‘"** å·²åŸºæœ¬è¾¾æˆã€‚ä»£ç å®ç°è¦†ç›–äº†æ‰€æœ‰ 9 ä¸ªå­ä»»åŠ¡ï¼ŒåŠŸèƒ½é“¾è·¯å®Œæ•´ï¼Œä¸ UX_Flow è®¾è®¡æ–‡æ¡£å¯¹ç…§æ— é‡å¤§åç¦»ã€‚

ä¸»è¦æ”¹è¿›æ–¹å‘ï¼š
1. **ä»£ç ç»„ç»‡**ï¼šæ‹†åˆ†è¿‡å¤§æ–‡ä»¶ï¼Œç»Ÿä¸€æ ·å¼ç®¡ç†
2. **æ ¡éªŒä½“éªŒ**ï¼šå¢å¼ºå³æ—¶æ ¡éªŒåé¦ˆ
3. **ç±»å‹æ•´ç†**ï¼šæ¸…ç†å†—ä½™å­—æ®µ

æ•´ä½“ä»£ç è´¨é‡è‰¯å¥½ï¼Œå¯è¿›å…¥ Phase4 å¼€å‘é˜¶æ®µã€‚

---

*å®¡æŸ¥äººï¼šClaude (AI Assistant)*  
*å®¡æŸ¥å·¥å…·ç‰ˆæœ¬ï¼šAntigravity 2024-12*
