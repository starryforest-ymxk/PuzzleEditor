# 交互规范（Interaction Guide）

> 本文档约定编辑器的统一交互规则与快捷键，适用于所有编辑视图。  
> **版本**: 1.0.0 | **更新时间**: 2025-12-15

---

## 1. 通用交互准则

### 1.1 选择与多选

| 操作 | 手势/快捷键 | 说明 |
|------|-------------|------|
| 单选 | 左键点击 | 选中单个对象 |
| 追加选择 | Ctrl/Cmd + 左键 | 添加到当前选中集合 |
| 框选 | 左键拖拽空白区域 | 框内对象全部选中 |
| 取消选择 | ESC 或点击空白 | 清空所有选中 |

### 1.2 编辑操作

| 操作 | 快捷键 | 说明 |
|------|--------|------|
| 删除 | Delete / Backspace | 删除选中对象（支持多选） |
| 撤销 | Ctrl/Cmd + Z | 撤销上一步操作 |
| 重做 | Ctrl/Cmd + Shift + Z | 恢复已撤销操作 |
| 重做（备用） | Ctrl/Cmd + Y | 同上 |

### 1.3 画布导航

| 操作 | 手势 | 说明 |
|------|------|------|
| 平移 | Space + 左键拖拽 | 移动画布视口 |
| 平移（备用） | 中键拖拽 | 同上 |
| 平移（备用） | Alt + 左键拖拽 | 同上 |
| 缩放 | Ctrl/Cmd + 滚轮 | 放大/缩小画布 |

### 1.4 右键菜单

- 右键点击对象：显示上下文菜单。
- 右键不会改变当前选中状态。
- 点击菜单外区域：关闭菜单。

---

## 2. FSM 画布快捷键

### 2.1 节点操作

| 操作 | 手势/快捷键 | 说明 |
|------|-------------|------|
| 创建节点 | 右键 → Add State | 在点击位置创建状态 |
| 移动节点 | 左键拖拽节点 | 移动单个或多个选中节点 |
| 设为初始 | 右键 → Set Initial | 标记为状态机入口 |
| 删除节点 | Delete / Backspace | 同时删除相关连线 |

### 2.2 连线操作

| 操作 | 手势/快捷键 | 说明 |
|------|-------------|------|
| 创建连线 | Shift + 左键拖拽 | 从源节点拖向目标节点 |
| 创建连线（备用） | 右键 → Link | 进入连接模式后点击目标 |
| 选中连线 | 左键点击连线 | 选中后可在 Inspector 编辑 |
| 删除连线 | Delete / Backspace | 删除选中的连线 |
| 批量切断 | Ctrl + 左键拖拽 | 画红色虚线切断路径上连线 |

### 2.3 吸附提示

- 靠近目标节点边缘时显示黄色吸附点。
- 吸附半径：约 30px。
- 吸附位置：节点四侧锚点（top/right/bottom/left）。

---

## 3. 演出画布快捷键

> 演出画布继承 FSM 画布的交互规范，仅节点类型不同。

| 操作 | 手势/快捷键 | 说明 |
|------|-------------|------|
| 创建节点 | 右键 → Add Node | 选择节点类型后创建 |
| 连接节点 | 从节点端点拖拽 | 建立顺序/分支连接 |

---

## 4. 列表与树视图

| 操作 | 手势 | 说明 |
|------|------|------|
| 选中 | 左键单击 | 选中列表项或树节点 |
| 展开/折叠 | 点击三角图标 | 展开或折叠子节点 |
| 进入编辑 | 左键双击 | 进入详情或编辑模式 |
| Stage 拖拽排序/移动 | 拖拽 Stage 行 | 节点行二态：鼠标在行的上/下区域表示 `between`（插入线，分别等价于插入到目标之前/之后），中间区域表示 `inside`（作为子节点，释放后自动展开目标）；底部空白区支持“离散档位”的层级指示线（在空白区上下移动会快速吸附切换目标父层级，越靠下越浅） |

补充说明：Stages 面板的拖拽落点计算被限定在 Stage 树容器内（仅统计带 `data-stage-id` 的节点），避免 Nodes 列表等复用 `.tree-node` 样式的区域影响“底部空白区域”指示线显示。

---

## 5. 实现状态

### 5.1 已实现

| 功能 | 位置 | 状态 |
|------|------|------|
| 全局撤销/重做 | `MainLayout.tsx` | ✔ |
| FSM 框选/多选 | `StateMachineCanvas.tsx` | ✔ |
| FSM 节点拖拽 | `useGraphInteraction.ts` | ✔ |
| FSM 连线创建 | `useGraphInteraction.ts` | ✔ |
| FSM 右键菜单 | `StateMachineCanvas.tsx` | ✔ |
| FSM 线切断 | `StateMachineCanvas.tsx` | ✔ |
| 画布平移 | `useCanvasNavigation.ts` | ✔ |

### 5.2 待实现

| 功能 | 说明 |
|------|------|
| 画布缩放 | 需接入滚轮缩放与居中重置策略 |
| 演出画布交互 | 继承 FSM 规则，待落地 |
| 黑板视图交互 | 阶段化演进中 |

---

## 6. 消息堆栈交互

- 顶栏 `Messages` 点击展开/收起堆栈，按时间倒序显示 `info / warning / error`。
- “清空”按钮立即清除消息列表，不影响后续新增。
- 加载/导入/校验/保存等全局操作失败时必须推送 `error` 消息；非阻塞警告推送 `warning`；普通成功提示推送 `info`。
- 弹出层仅展示，不影响主操作，关闭后仍保留历史（除非手动清空）。
